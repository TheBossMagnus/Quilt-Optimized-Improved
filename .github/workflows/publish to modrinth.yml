name: Automatically publish to Modrinth
on:
  release:
    types: [released]
  workflow_dispatch:

jobs:
  publish-to-modrinth:
    runs-on: ubuntu-22.04
    strategy:
      matrix:
        mc-version: ['1.16.5', '1.17.1','1.18.2','1.19.2','1.19.3','1.19.4','1.20.1']
        loader: ['fabric', 'quilt']
        exclude:
          - loader: 'quilt'
            mc-version: '1.16.5'
          - loader: 'quilt'
            mc-version: '1.17.1'

    steps:
       - name: Download the pack files
         uses: robinraju/release-downloader@v1.8
         with:
           fileName: '*'
           latest: true
           tarBall: false
           zipBall: false
           out-file-path: .

       - name: Check file existance
         id: files_exist
         uses: andstor/file-existence-action@v2
         with:
          files: "*${{ matrix.loader }}.${{ matrix.mc-version }}.mrpack, ${{ matrix.loader }}.${{ matrix.mc-version }}.Changelog.md"

       - name: Publish
         if: steps.files_exist.outputs.files_exists == 'true'
         uses: Kir-Antipov/mc-publish@v3.3
         with:
           modrinth-id: ehPxCT2J
           modrinth-token: ${{ secrets.MODRINTH }}
           files: '*${{ matrix.loader }}.${{ matrix.mc-version }}.mrpack'
           name: 'Thunder ${{ github.event.release.tag_name }} for ${{ matrix.loader }} ${{ matrix.mc-version }}'
           changelog-file: '${{ matrix.loader }}.${{ matrix.mc-version }}.Changelog.md'
           loaders: '${{ matrix.loader }}'
           game-versions: '${{ matrix.mc-version }}'