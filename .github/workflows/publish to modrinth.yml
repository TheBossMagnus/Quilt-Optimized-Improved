name: Automatically publish to Modrinth
on:
  release:
    types: [released]
  workflow_dispatch: #Manual trigger

jobs:
  publish-to-modrinth:
    runs-on: ubuntu-22.04
    strategy:
      matrix: # Run the job for each combination of loader and mc-version (https://docs.github.com/en/actions/using-jobs/using-a-matrix-for-your-jobs)
        mc-version: ["1.16.5","1.18.2","1.19.2","1.19.4","1.20.1","1.20.2"]
        loader: ["quilt", "fabric"]
        exclude:
          - loader: "quilt"
            mc-version: "1.16.5"
      max-parallel: 1

# Download all assets from the trigger release
    steps:
       - name: Download the pack files
         uses: robinraju/release-downloader@v1.8
         with:
           fileName: "*"
           tag: ${{ github.event.release.tag_name }}

# Check if the files to publish exist, if not go to the next matrix combination
       - name: Check file existance
         id: files_exist
         uses: andstor/file-existence-action@v2
         with:
          files: "Thunder-${{ github.event.release.tag_name }}+${{ matrix.loader }}-${{ matrix.mc-version }}.mrpack, Changelog-${{ github.event.release.tag_name }}+${{ matrix.loader }}-${{ matrix.mc-version }}.md"

# Publish the files to Modrinth
       - name: Publish
         if: steps.files_exist.outputs.files_exists == 'true'
         uses: Kir-Antipov/mc-publish@v3.3
         with:
           modrinth-id: ehPxCT2J
           modrinth-token: ${{ secrets.MODRINTH }}
           files: "Thunder-${{ github.event.release.tag_name }}+${{ matrix.loader }}-${{ matrix.mc-version }}.mrpack"
           name: "Thunder ${{ github.event.release.tag_name }} for ${{ matrix.loader }} ${{ matrix.mc-version }}"
           changelog-file: "Changelog-${{ github.event.release.tag_name }}+${{ matrix.loader }}-${{ matrix.mc-version }}.md"
           loaders: "${{ matrix.loader }}"
           game-versions: "${{ matrix.mc-version }}"